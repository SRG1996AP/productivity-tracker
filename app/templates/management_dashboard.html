{% extends "base.html" %}
{% block content %}
<div class="management-container">
    <h1>ðŸ“Š Management Dashboard - Overall Productivity</h1>
    
    <!-- Inject server-side data for client charts -->
    <script>
        const departmentNames = {{ department_stats|map(attribute='name')|list|tojson }};
        const departmentData = {{ department_stats|tojson }};
        const avgDurationData = {{ department_stats|map(attribute='avg_duration')|list|tojson }};
        // Color palette for charts
        const colors = [
            '#4dc9f6','#f67019','#f53794','#537bc4','#acc236','#166a8f','#00a950','#58595b','#8549ba',
            '#ff6384','#36a2eb','#cc65fe','#ffce56','#2ecc71','#e74c3c'
        ];
    </script>
    {# Flashed messages are rendered centrally in base.html to avoid duplicates #}
    
    <!-- Overall Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_users }}</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ departments_count }}</div>
            <div class="stat-label">Departments</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_entries }}</div>
            <div class="stat-label">Total Activities Logged</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_duration }}</div>
            <div class="stat-label">Total Minutes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ overall_avg_duration }}</div>
            <div class="stat-label">Avg Duration (mins)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ today_entries }}</div>
            <div class="stat-label">Today's Activities</div>
        </div>
    </div>

    <!-- Charts Controls -->
    <div class="charts-controls" style="margin-bottom:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <label style="font-weight:600;">From: <input type="date" id="startDate" /></label>
        <label style="font-weight:600;">To: <input type="date" id="endDate" /></label>
        <button id="applyDateFilter" class="btn btn-small">Apply</button>
        <button id="clearDateFilter" class="btn btn-small">Clear</button>
        <label style="font-weight:600;">Department:
            <select id="filterDept" style="margin-left:6px;">
                <option value="">All</option>
                {% for d in department_stats %}
                    {% if d.name != 'Management' %}
                    <option value="{{ d.id }}">{{ d.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </label>
        <label style="font-weight:600;">Priority:
            <select id="filterPriority" style="margin-left:6px;">
                <option value="">Any</option>
                <option>High</option>
                <option>Medium</option>
                <option>Low</option>
            </select>
        </label>
        <label style="font-weight:600;">Ticket Type:
            <input id="filterTicket" placeholder="exact match" style="margin-left:6px; padding:6px;" />
        </label>
        <button id="exportCsv" class="btn btn-small" style="background:#28a745; color:#fff;">Export CSV</button>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3>Activities by Department</h3>
            <div class="chart-empty" id="activitiesEmpty">No activity data available.</div>
            <canvas id="activitiesChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Duration by Department</h3>
            <div class="chart-empty" id="durationEmpty">No duration data available.</div>
            <canvas id="durationChart"></canvas>
        </div>
            <div class="chart-container">
                <h3>Activities Over Time</h3>
                <canvas id="timeSeriesChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Top Users by Activity Count</h3>
                <canvas id="topUsersChart"></canvas>
            </div>
        <div class="chart-container">
            <h3>Users by Department</h3>
            <div class="chart-empty" id="usersEmpty">No user data available.</div>
            <canvas id="usersChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Ticket Type Breakdown</h3>
            <div class="chart-empty" id="ticketTypeEmpty">No ticket type data available.</div>
            <canvas id="ticketTypeChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Day / Hour Heatmap</h3>
            <div class="chart-empty" id="heatmapEmpty">No heatmap data available.</div>
            <div id="heatmapGrid" style="overflow:auto; padding-top:8px;"></div>
        </div>
        <div class="chart-container">
            <h3>Average Duration by Department</h3>
            <div class="chart-empty" id="avgDurationEmpty">No average duration data available.</div>
            <canvas id="avgDurationChart"></canvas>
        </div>
    </div>

    <!-- Department Breakdown -->
    <div class="section-container">
        <h2>ðŸ“‹ Department Breakdown</h2>
        <table class="stats-table">
            <thead>
                <tr>
                    <th>Department</th>
                    <th>Users</th>
                    <th>Total Activities</th>
                    <th>Total Duration (mins)</th>
                    <th>Avg Duration (mins)</th>
                </tr>
            </thead>
            <tbody>
                {% for dept in department_stats %}
                    {% if dept.name != 'Management' %}
                    <tr>
                        <td><strong>{{ dept.name }}</strong></td>
                        <td><span class=\"badge\">{{ dept.users_count }}</span></td>
                        <td>{{ dept.total_entries }}</td>
                        <td>{{ dept.total_duration }}</td>
                        <td>{{ dept.avg_duration }}</td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{{ url_for('main.admin_users') }}" class="btn btn-primary">ðŸ‘¥ Manage Users</a>
        <a href="{{ url_for('main.logout') }}" class="btn btn-secondary">ðŸšª Logout</a>
    </div>
</div>

<style>
.management-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.management-container h1 {
    color: #333;
    margin-bottom: 30px;
    text-align: center;
    font-size: 28px;
}

.management-container h2 {
    color: #444;
    margin-top: 40px;
    margin-bottom: 20px;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
    font-size: 22px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    text-align: center;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
}

.stat-value {
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 10px;
}

.stat-label {
    font-size: 14px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.section-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.stats-table thead {
    background-color: #f8f9fa;
}

.stats-table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #ddd;
    font-size: 14px;
}

.stats-table td {
    padding: 15px;
    border-bottom: 1px solid #eee;
    color: #555;
}

.stats-table tbody tr:hover {
    background-color: #f8f9fa;
}

.badge {
    background-color: #667eea;
    color: white;
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
}

.chart-container {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.chart-container h3 {
    margin-top: 0;
    color: #555;
    font-size: 16px;
}

.chart-container canvas {
    max-height: 350px;
    min-height: 300px;
}

.chart-empty {
    min-height: 300px;
    display: none;
    align-items: center;
    justify-content: center;
    color: #999;
    font-style: italic;
}

.btn-small {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 4px;
    text-decoration: none;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
}

.btn-info {
    background-color: #17a2b8;
    color: white;
}

.btn-info:hover {
    background-color: #138496;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 30px;
}

.btn {
    display: inline-block;
    padding: 12px 25px;
    border-radius: 4px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    font-size: 14px;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.flash {
    padding: 12px 15px;
    border-radius: 4px;
    margin-bottom: 15px;
}

.flash.danger {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.flash.success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    .charts-section {
        grid-template-columns: 1fr;
    }

    .stats-table {
        font-size: 12px;
    }

    .stats-table th,
    .stats-table td {
        padding: 10px;
    }

    .management-container h1 {
        font-size: 22px;
    }
}
</style>

<script>
// Ensure data exists
console.log('Department Data:', departmentData);
console.log('Department Names:', departmentNames);

// Activities Chart: fetch counts from API (allows date filtering)
const startInput = document.getElementById('startDate');
const endInput = document.getElementById('endDate');
const applyBtn = document.getElementById('applyDateFilter');
const clearBtn = document.getElementById('clearDateFilter');

let activitiesChart = null;

async function loadActivitiesChart(start, end, dept, priority) {
    try {
        const params = new URLSearchParams();
        if (start) params.append('start', start);
        if (end) params.append('end', end);
        if (dept) params.append('dept', dept);
        if (priority) params.append('priority', priority);
        const url = '/api/management/activities-by-dept' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url);
        if (!res.ok) {
            console.error('Failed to fetch activities-by-dept', res.status);
            return;
        }
        const data = await res.json();
        const labels = data.labels || departmentNames;
        const counts = data.counts || [];

        const ctx = document.getElementById('activitiesChart');
        if (!ctx) return;
        if (activitiesChart) activitiesChart.destroy();
        activitiesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Activities',
                    data: counts,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: colors.slice(0, labels.length),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: { intersect: false, mode: 'index' },
                plugins: { legend: { display: true } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    } catch (err) {
        console.error('Error loading activities chart', err);
    }
}

// Initial load
loadActivitiesChart();
// helper to show/hide empties
function showEmpty(id, show) {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.display = show ? 'flex' : 'none';
}

// Ticket Type Breakdown (Pie)
let ticketTypeChart = null;
async function loadTicketTypeChart(start, end, dept, priority) {
    try {
        const params = new URLSearchParams();
        if (start) params.append('start', start);
        if (end) params.append('end', end);
        if (dept) params.append('dept', dept);
        if (priority) params.append('priority', priority);
        const url = '/api/management/ticket-types' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url);
        if (!res.ok) return console.error('Failed to fetch ticket-types', res.status);
        const data = await res.json();
        const labels = data.labels || [];
        const counts = data.counts || [];

        const treemapDiv = document.getElementById('treemapDiv');
        const ctx = document.getElementById('ticketTypeChart');
        if (!treemapDiv || !ctx) return;
        if (labels.length === 0 || counts.every(c => c === 0)) { showEmpty('ticketTypeEmpty', true); return; }
        showEmpty('ticketTypeEmpty', false);

        // Build Google Charts data
        const gdata = [['Type','Parent','Value']];
        gdata.push(['All', null, 0]);
        for (let i = 0; i < labels.length; i++) {
            gdata.push([labels[i], 'All', counts[i]]);
        }

        function drawTreemap() {
            try {
                const dt = google.visualization.arrayToDataTable(gdata);
                const tree = new google.visualization.TreeMap(treemapDiv);
                tree.draw(dt, {minColor:'#f6c7c2', midColor:'#ffd580', maxColor:'#4caf50', headerHeight:15, fontColor:'black', showScale:true});
                ctx.style.display = 'none';
            } catch (e) {
                console.error('Treemap draw failed', e);
            }
        }

        if (typeof google === 'undefined' || !google.visualization) {
            const s = document.createElement('script');
            s.src = 'https://www.gstatic.com/charts/loader.js';
            s.onload = () => { google.charts.load('current', {'packages':['treemap']}); google.charts.setOnLoadCallback(drawTreemap); };
            document.head.appendChild(s);
        } else {
            if (!google.visualization) { google.charts.load('current', {'packages':['treemap']}); google.charts.setOnLoadCallback(drawTreemap); }
            else drawTreemap();
        }
    } catch (err) {
        console.error('Error loading ticket type chart', err);
    }
}

// Day/Hour Heatmap
async function loadDayHourHeatmap(start, end, dept, priority) {
    try {
        const params = new URLSearchParams();
        if (start) params.append('start', start);
        if (end) params.append('end', end);
        if (dept) params.append('dept', dept);
        if (priority) params.append('priority', priority);
        const url = '/api/management/day-hour-heatmap' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url);
        if (!res.ok) return console.error('Failed to fetch heatmap', res.status);
        const data = await res.json();
        const weekdays = data.weekdays || [];
        const hours = data.hours || [];
        const matrix = data.matrix || [];

        const container = document.getElementById('heatmapGrid');
        if (!container) return;
        if (!matrix.length) { showEmpty('heatmapEmpty', true); return; }
        showEmpty('heatmapEmpty', false);

        // Build table-like grid
        let html = '<table class="heatmap-table" style="border-collapse:collapse; width:100%;">';
        // header
        html += '<thead><tr><th style="padding:6px; text-align:left;">Hour\Day</th>';
        weekdays.forEach(d => { html += `<th style="padding:6px; text-align:center; font-weight:600;">${d}</th>`; });
        html += '</tr></thead><tbody>';

        // Add legend at top
        const legendHtml = '<div style="margin-bottom:12px; display:flex; align-items:center; gap:8px; font-size:12px; flex-wrap:wrap;">' +
            '<strong>Activity Intensity:</strong>' +
            '<div style="width:30px; height:20px; background:hsl(22, 50%, 92%); border:1px solid #ddd; border-radius:3px;"></div><span>Low</span>' +
            '<div style="width:30px; height:20px; background:hsl(50, 80%, 60%); border:1px solid #ddd; border-radius:3px;"></div><span>Med</span>' +
            '<div style="width:30px; height:20px; background:hsl(85, 65%, 45%); border:1px solid #ddd; border-radius:3px;"></div><span>High</span>' +
            '</div>';

        // find max for scaling
        let max = 0;
        matrix.forEach(row => row.forEach(v => { if (v > max) max = v; }));

        for (let h = 0; h < hours.length; h++) {
            html += `<tr><td style="padding:6px; font-weight:600;">${hours[h]}:00</td>`;
            for (let d = 0; d < weekdays.length; d++) {
                const val = (matrix[d] && matrix[d][h]) ? matrix[d][h] : 0;
                // Color gradient: low (light) to high (darker, warmer)
                let hue, sat, light;
                if (max === 0) { hue = 0; sat = 0; light = 95; }
                else {
                    const pct = val / max; // 0..1 (0=no activity, 1=max activity)
                    // Hue: 22 (orange) at low â†’ 85 (green) at high
                    hue = Math.round(22 + (85 - 22) * (1 - pct));
                    // Saturation: 50% at low â†’ 100% at high
                    sat = 50 + (50 * pct);
                    // Lightness: 92% at low â†’ 45% at high
                    light = 92 - (47 * pct);
                }
                const bg = `hsl(${hue}, ${sat}%, ${light}%)`;
                const cellId = `hcell_${d}_${h}`;
                html += `<td id="${cellId}" style="padding:6px; text-align:center; background:${bg}; cursor:pointer; border:1px solid #eee; transition:box-shadow 0.2s; font-weight:500;" data-day="${weekdays[d]}" data-hour="${hours[h]}" data-val="${val}">${val}</td>`;
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        container.innerHTML = legendHtml + html;

        // Add interactive hover tooltips
        const cells = container.querySelectorAll('td[data-val]');
        cells.forEach(cell => {
            cell.addEventListener('mouseenter', (e) => {
                const day = cell.getAttribute('data-day');
                const hour = cell.getAttribute('data-hour');
                const val = cell.getAttribute('data-val');
                cell.title = `${day} at ${hour}:00 â€“ ${val} ${parseInt(val)===1 ? 'activity' : 'activities'}`;
                cell.style.boxShadow = '0 0 8px rgba(0,0,0,0.4), inset 0 0 3px rgba(255,255,255,0.5)';
                cell.style.transform = 'scale(1.05)';
                cell.style.zIndex = '10';
            });
            cell.addEventListener('mouseleave', () => {
                cell.style.boxShadow = 'none';
                cell.style.transform = 'scale(1)';
            });
        });

    } catch (err) {
        console.error('Error loading heatmap', err);
    }
}

// wire apply/clear to all loaders and connect filters
if (applyBtn) applyBtn.addEventListener('click', () => {
    const s = startInput.value;
    const e = endInput.value;
    const dept = document.getElementById('filterDept').value;
    const pr = document.getElementById('filterPriority').value;
    const tk = document.getElementById('filterTicket').value.trim();

    console.log('Apply clicked with:', {start: s, end: e, dept: dept, priority: pr, ticket: tk});
    loadActivitiesChart(s, e, dept, pr);
    loadDurationChart(s, e, dept, pr);
    loadAvgDurationChart(s, e, dept, pr);
    loadTimeSeriesChart(s, e, dept);
    loadTopUsersChart(s, e, dept);
    loadUsersByDeptChart(s, e);
    loadTicketTypeChart(s, e, dept, pr);
    loadDayHourHeatmap(s, e, dept, pr);
});

if (clearBtn) clearBtn.addEventListener('click', () => {
    startInput.value = '';
    endInput.value = '';
    document.getElementById('filterDept').value = '';
    document.getElementById('filterPriority').value = '';
    document.getElementById('filterTicket').value = '';
    loadActivitiesChart();
    loadDurationChart();
    loadAvgDurationChart();
    loadTimeSeriesChart();
    loadTopUsersChart();
    loadUsersByDeptChart();
    loadTicketTypeChart();
    loadDayHourHeatmap();
});

// Export CSV handler
const exportBtn = document.getElementById('exportCsv');
if (exportBtn) exportBtn.addEventListener('click', async () => {
    const params = new URLSearchParams();
    const s = startInput.value; const e = endInput.value;
    if (s) params.append('start', s);
    if (e) params.append('end', e);
    const dept = document.getElementById('filterDept').value;
    if (dept) params.append('dept', dept);
    const pr = document.getElementById('filterPriority').value;
    if (pr) params.append('priority', pr);
    const tk = document.getElementById('filterTicket').value.trim();
    if (tk) params.append('ticket_type', tk);

    const url = '/api/management/export' + (params.toString() ? ('?' + params.toString()) : '');
    const res = await fetch(url);
    if (!res.ok) { alert('Export failed'); return; }
    const blob = await res.blob();
    const urlBlob = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlBlob;
    a.download = 'activities_export.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(urlBlob);
});

// initial load for all charts
loadActivitiesChart();
loadDurationChart();
loadAvgDurationChart();
loadTimeSeriesChart();
loadTopUsersChart();
loadUsersByDeptChart();
loadTicketTypeChart();
loadDayHourHeatmap();

// Duration Chart (Stacked by Priority)
let durationChart = null;
async function loadDurationChart(start, end, dept, priority) {
    try {
        const params = new URLSearchParams();
        if (start) params.append('start', start);
        if (end) params.append('end', end);
        if (dept) params.append('dept', dept);
        if (priority) params.append('priority', priority);
        const url = '/api/management/duration-by-dept' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url);
        if (!res.ok) {
            console.error('Failed to fetch duration-by-dept', res.status);
            return;
        }
        const data = await res.json();
        const labels = data.labels || departmentNames;
        const priorities = data.priorities || [];
        const series = data.series || [];

        const datasets = series.map((s, idx) => ({
            label: s.priority,
            data: s.durations,
            backgroundColor: colors[idx % colors.length]
        }));

        const ctx = document.getElementById('durationChart');
        if (!ctx) return;
        if (durationChart) durationChart.destroy();
        durationChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                }
            }
        });
    } catch (err) {
        console.error('Error loading duration chart', err);
    }
}

// Average Duration Chart (Line)
let avgChart = null;
async function loadAvgDurationChart(start, end, dept, priority) {
    try {
        const params = new URLSearchParams();
        if (start) params.append('start', start);
        if (end) params.append('end', end);
        if (dept) params.append('dept', dept);
        if (priority) params.append('priority', priority);
        const url = '/api/management/avg-duration-by-dept' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url);
        if (!res.ok) {
            console.error('Failed to fetch avg-duration-by-dept', res.status);
            return;
        }
        const data = await res.json();
        const labels = data.labels || departmentNames;
        const avgs = data.averages || [];

        const ctx = document.getElementById('avgDurationChart');
        if (!ctx) return;
        if (avgChart) avgChart.destroy();
        avgChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Avg Duration (mins)',
                    data: avgs,
                    borderColor: '#ff7f50',
                    backgroundColor: 'rgba(255,127,80,0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: true } },
                scales: { y: { beginAtZero: true } }
            }
        });
    } catch (err) {
        console.error('Error loading avg duration chart', err);
    }
}

// Activities Over Time (Line/Area)
let timeSeriesChart = null;
async function loadTimeSeriesChart(start, end, dept) {
    try {
        const params = new URLSearchParams();
        if (start) params.append('start', start);
        if (end) params.append('end', end);
        if (dept) params.append('dept', dept);
        const url = '/api/management/activities-over-time' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url);
        if (!res.ok) {
            console.error('Failed to fetch activities-over-time', res.status);
            return;
        }
        const data = await res.json();
        const labels = data.labels || [];
        const counts = data.counts || [];

        const ctx = document.getElementById('timeSeriesChart');
        if (!ctx) return;
        if (timeSeriesChart) timeSeriesChart.destroy();
        timeSeriesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Activities',
                    data: counts,
                    borderColor: '#4facfe',
                    backgroundColor: 'rgba(79,172,254,0.12)',
                    fill: true,
                    tension: 0.2,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: true } },
                scales: { y: { beginAtZero: true } }
            }
        });
    } catch (err) {
        console.error('Error loading time series chart', err);
    }
}

// Users by Department (Donut/Pie) - dynamic (mode=all|active)
let usersByDeptChart = null;
async function loadUsersByDeptChart(start, end, mode='all') {
    try {
        const params = new URLSearchParams();
        if (mode) params.append('mode', mode);
        if (start) params.append('start', start);
        if (end) params.append('end', end);
        const url = '/api/management/users-by-dept' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url);
        if (!res.ok) {
            console.error('Failed to fetch users-by-dept', res.status);
            return;
        }
        const data = await res.json();
        const labels = data.labels || departmentNames;
        const counts = data.counts || [];

        const ctx = document.getElementById('usersChart');
        if (!ctx) return;
        if (usersByDeptChart) usersByDeptChart.destroy();
        usersByDeptChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: colors.slice(0, labels.length),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    } catch (err) {
        console.error('Error loading users-by-dept chart', err);
    }
}

// Top Users Chart (Horizontal Bar)
let topUsersChart = null;
async function loadTopUsersChart(start, end, dept, limit=8) {
    try {
        const params = new URLSearchParams();
        if (start) params.append('start', start);
        if (end) params.append('end', end);
        if (dept) params.append('dept', dept);
        params.append('limit', limit);
        const url = '/api/management/top-users' + (params.toString() ? ('?' + params.toString()) : '');
        const res = await fetch(url);
        if (!res.ok) {
            console.error('Failed to fetch top-users', res.status);
            return;
        }
        const data = await res.json();
        const users = data.users || [];
        const counts = data.counts || [];

        const ctx = document.getElementById('topUsersChart');
        if (!ctx) return;
        if (topUsersChart) topUsersChart.destroy();
        topUsersChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: users,
                datasets: [{
                    label: 'Activities',
                    data: counts,
                    backgroundColor: colors.slice(0, users.length),
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true } }
            }
        });
    } catch (err) {
        console.error('Error loading top users chart', err);
    }
}

// initial loads
loadTopUsersChart();
loadUsersByDeptChart();

// Average Duration Chart (Line)
const avgCtx = document.getElementById('avgDurationChart');
if (avgCtx && avgDurationData && avgDurationData.length > 0) {
    new Chart(avgCtx, {
        type: 'line',
        data: {
            labels: departmentNames,
            datasets: [{
                label: 'Average Duration (mins)',
                data: avgDurationData,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: true },
                title: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { stepSize: 25 }
                }
            }
        }
    });
} else {
    console.log('No avg duration data - showing placeholder');
    showEmpty('avgDurationEmpty', true);
}
</script>
{% endblock %}
